# Bedtime Stories - Cursor AI Rules

Follow these patterns for consistency. See `V0_INTEGRATION.md` for UI redesign workflow.

## ğŸ—ï¸ Architecture

### Tech Stack
- Next.js 16.1.6 App Router + TypeScript
- Tailwind CSS v4 (default palette only)
- Supabase Auth (@supabase/ssr)
- Cloudflare R2 (AWS SDK v3)

### Structure
```
src/
â”œâ”€â”€ app/              # Pages (orchestration only)
â”œâ”€â”€ components/       # UI only (no DB/API calls)
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ actions/      # Server Actions (mutations)
â”‚   â”œâ”€â”€ api/          # API client utilities
â”‚   â”œâ”€â”€ queries/      # Database reads
â”‚   â””â”€â”€ supabase/     # Client helpers
```

### Separation of Concerns
- **Pages**: Fetch data â†’ Pass to components
- **Components**: Render UI only (data from props)
- **lib/actions**: Mutations (create, update, delete)
- **lib/queries**: Database reads
- **lib/api**: Client-side API calls

## ğŸ” Authentication

**No Middleware** - Auth checks at page/route level (avoids Edge Runtime issues).

### Protected Pages
```typescript
import { requireAuth } from '@/lib/auth';
import { getStories } from '@/lib/queries/stories';
import StoriesList from '@/components/StoriesList';

export default async function Home() {
  const user = await requireAuth();
  const { stories } = await getStories();
  return <StoriesList stories={stories} userEmail={user.email} />;
}
```

### Protected API Routes
```typescript
import { requireAuthAPI } from '@/lib/auth';

export async function GET() {
  const { error, user } = await requireAuthAPI();
  if (error) return error;
  // ... protected logic
}
```

### Auth Forms (Login/Signup)
Page wrappers must be client components to pass functions:

```typescript
// app/login/page.tsx
'use client';

import { login } from '@/lib/actions/auth';
import LoginForm from '@/components/LoginForm';

export default function LoginPage() {
  async function handleLogin(email: string, password: string) {
    const result = await login(email, password);
    if (result?.error) throw new Error(result.error);
  }
  return <LoginForm onSubmit={handleLogin} />;
}
```

### âŒ NEVER Use Supabase Clients Directly

**Only allowed in:**
- `lib/actions/*`, `lib/queries/*`, `lib/auth.ts`

**Never in:**
- `components/*` (use props/callbacks)
- `app/*` pages (use query functions/actions)

## ğŸ¨ Styling

### Ocean Theme (Default Tailwind Only)
- Background: `bg-slate-50`
- Headings: `text-blue-950`
- Buttons: `bg-blue-950 hover:bg-blue-900 text-white`
- Links: `text-teal-500`
- Badges: `bg-teal-50 text-teal-700`
- Success: `bg-emerald-50 text-emerald-800`
- Error: `bg-red-50 text-red-800`
- Cards: `bg-white border-slate-200`

### Rules
- âœ… Default Tailwind palette only (no custom colors)
- âœ… No dark mode (MVP simplified)
- âœ… Ocean theme throughout (blue-950, teal-500, slate)
- âœ… Include `transition-colors` on interactive elements
- âŒ Never extend tailwind config

## ğŸ“ TypeScript

- Use `type` keyword for type-only imports
- Import shared types from `@/lib/types`
- Type all event handlers: `FormEvent<HTMLFormElement>`
- Use `Readonly<>` for props when appropriate

## ğŸ”§ Environment Variables

Required in `.env.local`:
```env
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=sb_publishable_xxx
R2_ACCOUNT_ID=xxx
R2_ACCESS_KEY_ID=xxx
R2_SECRET_ACCESS_KEY=xxx
R2_BUCKET=bedtime-stories
```

- Use `sb_publishable_*` format (not legacy `eyJ...`)
- Never commit `.env.local`
- Never use `NODE_TLS_REJECT_UNAUTHORIZED=0` (turn off Zscaler)

## ğŸ“¦ Imports

- Always use `@/` alias for src imports
- Import order: Next/React â†’ Third-party â†’ Local utils â†’ Components â†’ Types

## ğŸš« Anti-Patterns

### âŒ No Middleware
- Causes Edge Runtime fetch issues in Next.js 16

### âŒ No Business Logic in Components
```typescript
// âŒ BAD
const supabase = createClient(); // In component

// âœ… GOOD
interface Props { stories: Story[] }
export default function MyComponent({ stories }: Props) { ... }
```

### âŒ No Direct Database Queries in Pages
```typescript
// âŒ BAD
const { data } = await supabase.from('stories').select('*');

// âœ… GOOD
const { stories } = await getStories();
```

## âœ… Principles

### DRY
- Use helpers: `requireAuth()`, `getStories()`, etc.
- No repeated auth checks or queries

### Separation
- Pages: Orchestrate (fetch â†’ pass props)
- Components: UI only (no fetching/DB)
- lib/: All business logic

### Security
- `requireAuth()` for protected pages
- `requireAuthAPI()` for API routes
- Validate inputs in API routes
- RLS enabled in Supabase

### Performance
- Server components for data fetching
- Minimize client JS

## ğŸ“š Key Files

### Business Logic
- `lib/auth.ts` - requireAuth(), requireAuthAPI()
- `lib/actions/` - Server actions (login, signup, createStoryRecord)
- `lib/queries/` - DB reads (getStories, getStoryById)
- `lib/api/` - API utils (getVideoUrl, getUploadUrl, uploadToR2)
- `lib/r2.ts` - R2 signed URLs
- `lib/types.ts` - Shared types

### UI (components/)
- Pure presentational components
- LoginForm, SignupForm, StoriesList, StoryDetail, VideoPlayer

### Pages (app/)
- Orchestrators (fetch â†’ render component)
- No business logic

### API Routes (app/api/)
- `upload-url/route.ts` - R2 upload URL
- `video-url/route.ts` - R2 video URL

## ğŸ¯ Quick Patterns

### Add Protected Page
```typescript
// app/new-page/page.tsx
import { requireAuth } from '@/lib/auth';
import { getData } from '@/lib/queries/data';
import MyComponent from '@/components/MyComponent';

export default async function Page() {
  await requireAuth();
  const { data } = await getData();
  return <MyComponent data={data} />;
}
```

### Add Form
1. Server action in `lib/actions/`
2. UI component in `components/` (receive onSubmit prop)
3. Page wrapper passes action as callback

### Redesign with v0
Read `V0_INTEGRATION.md` â†’ Keep props interface â†’ Replace component

## ğŸ“Œ Core Rules

- **No middleware** (Edge Runtime issues)
- **No Supabase in components** (use actions/queries)
- **No fetching in pages** (use query functions)
- **Props over fetching** (pass data down)
- **Ocean theme only** (blue-950, teal-500, slate)
- **Server > Client** (prefer server components)
